shadow$provide[147]=function(r,l,A,p){var k=l(0);r=l(73);var m=l(102),d=l(8),c=l(134),a=l(146);const b=new m.Rectangle;class e{constructor(g){this.renderer=g;this.managedFramebuffers=[];this.unknownFramebuffer=new c.Framebuffer(10,10);this.msaaSamples=null}contextChange(){this.disposeAll(!0);const g=this.gl=this.renderer.gl;if(this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.current=this.unknownFramebuffer,this.viewport=new m.Rectangle,this.hasMRT=!0,this.writeDepthTexture=!0,1===this.renderer.context.webGLVersion){let f=
this.renderer.context.extensions.drawBuffers,h=this.renderer.context.extensions.depthTexture;d.settings.PREFER_ENV===k.ENV.WEBGL_LEGACY&&(f=null,h=null);f?g.drawBuffers=n=>f.drawBuffersWEBGL(n):(this.hasMRT=!1,g.drawBuffers=()=>{});h||(this.writeDepthTexture=!1)}else this.msaaSamples=g.getInternalformatParameter(g.RENDERBUFFER,g.RGBA8,g.SAMPLES)}bind(g,f,h=0){var {gl:n}=this;if(g){var q=g.glFramebuffers[this.CONTEXT_UID]||this.initFramebuffer(g);this.current!==g&&(this.current=g,n.bindFramebuffer(n.FRAMEBUFFER,
q.framebuffer));q.mipLevel!==h&&(g.dirtyId++,g.dirtyFormat++,q.mipLevel=h);q.dirtyId!==g.dirtyId&&(q.dirtyId=g.dirtyId,q.dirtyFormat!==g.dirtyFormat?(q.dirtyFormat=g.dirtyFormat,q.dirtySize=g.dirtySize,this.updateFramebuffer(g,h)):q.dirtySize!==g.dirtySize&&(q.dirtySize=g.dirtySize,this.resizeFramebuffer(g)));for(n=0;n<g.colorTextures.length;n++)q=g.colorTextures[n],this.renderer.texture.unbind(q.parentTextureArray||q);(g.depthTexture&&this.renderer.texture.unbind(g.depthTexture),f)?(g=f.width>>h,
n=g/f.width,this.setViewport(f.x*n,f.y*n,g,f.height>>h)):this.setViewport(0,0,g.width>>h,g.height>>h)}else this.current&&(this.current=null,n.bindFramebuffer(n.FRAMEBUFFER,null)),f?this.setViewport(f.x,f.y,f.width,f.height):this.setViewport(0,0,this.renderer.width,this.renderer.height)}setViewport(g,f,h,n){const q=this.viewport;g=Math.round(g);f=Math.round(f);h=Math.round(h);n=Math.round(n);q.width===h&&q.height===n&&q.x===g&&q.y===f||(q.x=g,q.y=f,q.width=h,q.height=n,this.gl.viewport(g,f,h,n))}get size(){return this.current?
{x:0,y:0,width:this.current.width,height:this.current.height}:{x:0,y:0,width:this.renderer.width,height:this.renderer.height}}clear(g,f,h,n,q=k.BUFFER_BITS.COLOR|k.BUFFER_BITS.DEPTH){const {gl:t}=this;t.clearColor(g,f,h,n);t.clear(q)}initFramebuffer(g){var {gl:f}=this;f=new a.GLFramebuffer(f.createFramebuffer());return f.multisample=this.detectSamples(g.multisample),g.glFramebuffers[this.CONTEXT_UID]=f,this.managedFramebuffers.push(g),g.disposeRunner.add(this),f}resizeFramebuffer(g){const {gl:f}=
this,h=g.glFramebuffers[this.CONTEXT_UID];if(h.stencil){f.bindRenderbuffer(f.RENDERBUFFER,h.stencil);var n;1===this.renderer.context.webGLVersion?n=f.DEPTH_STENCIL:g.depth&&g.stencil?n=f.DEPTH24_STENCIL8:g.depth?n=f.DEPTH_COMPONENT24:n=f.STENCIL_INDEX8;h.msaaBuffer?f.renderbufferStorageMultisample(f.RENDERBUFFER,h.multisample,n,g.width,g.height):f.renderbufferStorage(f.RENDERBUFFER,n,g.width,g.height)}n=g.colorTextures;let q=n.length;f.drawBuffers||(q=Math.min(q,1));for(let u=0;u<q;u++){var t=n[u];
t=t.parentTextureArray||t;this.renderer.texture.bind(t,0);0===u&&h.msaaBuffer&&(f.bindRenderbuffer(f.RENDERBUFFER,h.msaaBuffer),f.renderbufferStorageMultisample(f.RENDERBUFFER,h.multisample,t._glTextures[this.CONTEXT_UID].internalFormat,g.width,g.height))}g.depthTexture&&this.writeDepthTexture&&this.renderer.texture.bind(g.depthTexture,0)}updateFramebuffer(g,f){const {gl:h}=this,n=g.glFramebuffers[this.CONTEXT_UID];var q=g.colorTextures;let t=q.length;h.drawBuffers||(t=Math.min(t,1));1<n.multisample&&
this.canMultisampleFramebuffer(g)?n.msaaBuffer=n.msaaBuffer||h.createRenderbuffer():n.msaaBuffer&&(h.deleteRenderbuffer(n.msaaBuffer),n.msaaBuffer=null,n.blitFramebuffer&&(n.blitFramebuffer.dispose(),n.blitFramebuffer=null));const u=[];for(let v=0;v<t;v++){const x=q[v],z=x.parentTextureArray||x;this.renderer.texture.bind(z,0);0===v&&n.msaaBuffer?(h.bindRenderbuffer(h.RENDERBUFFER,n.msaaBuffer),h.renderbufferStorageMultisample(h.RENDERBUFFER,n.multisample,z._glTextures[this.CONTEXT_UID].internalFormat,
g.width,g.height),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.RENDERBUFFER,n.msaaBuffer)):(h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0+v,x.target,z._glTextures[this.CONTEXT_UID].texture,f),u.push(h.COLOR_ATTACHMENT0+v))}if(1<u.length&&h.drawBuffers(u),g.depthTexture&&this.writeDepthTexture)q=g.depthTexture,this.renderer.texture.bind(q,0),h.framebufferTexture2D(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.TEXTURE_2D,q._glTextures[this.CONTEXT_UID].texture,f);if(!g.stencil&&!g.depth||
g.depthTexture&&this.writeDepthTexture)n.stencil&&(h.deleteRenderbuffer(n.stencil),n.stencil=null);else{n.stencil=n.stencil||h.createRenderbuffer();let v,x;1===this.renderer.context.webGLVersion?(v=h.DEPTH_STENCIL_ATTACHMENT,x=h.DEPTH_STENCIL):g.depth&&g.stencil?(v=h.DEPTH_STENCIL_ATTACHMENT,x=h.DEPTH24_STENCIL8):g.depth?(v=h.DEPTH_ATTACHMENT,x=h.DEPTH_COMPONENT24):(v=h.STENCIL_ATTACHMENT,x=h.STENCIL_INDEX8);h.bindRenderbuffer(h.RENDERBUFFER,n.stencil);n.msaaBuffer?h.renderbufferStorageMultisample(h.RENDERBUFFER,
n.multisample,x,g.width,g.height):h.renderbufferStorage(h.RENDERBUFFER,x,g.width,g.height);h.framebufferRenderbuffer(h.FRAMEBUFFER,v,h.RENDERBUFFER,n.stencil)}}canMultisampleFramebuffer(g){return 1!==this.renderer.context.webGLVersion&&1>=g.colorTextures.length&&!g.depthTexture}detectSamples(g){const {msaaSamples:f}=this;let h=k.MSAA_QUALITY.NONE;if(1>=g||null===f)return h;for(let n=0;n<f.length;n++)if(f[n]<=g){h=f[n];break}return 1===h&&(h=k.MSAA_QUALITY.NONE),h}blit(g,f,h){const {current:n,renderer:q,
gl:t,CONTEXT_UID:u}=this;if(2===q.context.webGLVersion&&n){var v=n.glFramebuffers[u];if(v){if(!g){if(!v.msaaBuffer)return;var x=n.colorTextures[0];if(!x)return;v.blitFramebuffer||(v.blitFramebuffer=new c.Framebuffer(n.width,n.height),v.blitFramebuffer.addColorTexture(0,x));g=v.blitFramebuffer;g.colorTextures[0]!==x&&(g.colorTextures[0]=x,g.dirtyId++,g.dirtyFormat++);g.width===n.width&&g.height===n.height||(g.width=n.width,g.height=n.height,g.dirtyId++,g.dirtySize++)}f||(f=b,f.width=n.width,f.height=
n.height);h||(h=f);x=f.width===h.width&&f.height===h.height;this.bind(g);t.bindFramebuffer(t.READ_FRAMEBUFFER,v.framebuffer);t.blitFramebuffer(f.left,f.top,f.right,f.bottom,h.left,h.top,h.right,h.bottom,t.COLOR_BUFFER_BIT,x?t.NEAREST:t.LINEAR);t.bindFramebuffer(t.READ_FRAMEBUFFER,g.glFramebuffers[this.CONTEXT_UID].framebuffer)}}}disposeFramebuffer(g,f){const h=g.glFramebuffers[this.CONTEXT_UID],n=this.gl;if(h){delete g.glFramebuffers[this.CONTEXT_UID];var q=this.managedFramebuffers.indexOf(g);0<=
q&&this.managedFramebuffers.splice(q,1);g.disposeRunner.remove(this);f||(n.deleteFramebuffer(h.framebuffer),h.msaaBuffer&&n.deleteRenderbuffer(h.msaaBuffer),h.stencil&&n.deleteRenderbuffer(h.stencil));h.blitFramebuffer&&this.disposeFramebuffer(h.blitFramebuffer,f)}}disposeAll(g){const f=this.managedFramebuffers;this.managedFramebuffers=[];for(let h=0;h<f.length;h++)this.disposeFramebuffer(f[h],g)}forceStencil(){const g=this.current;if(g){var f=g.glFramebuffers[this.CONTEXT_UID];if(!(!f||f.stencil&&
g.stencil)){g.stencil=!0;var h=g.width,n=g.height,q=this.gl,t=f.stencil=q.createRenderbuffer();q.bindRenderbuffer(q.RENDERBUFFER,t);var u,v;1===this.renderer.context.webGLVersion?(u=q.DEPTH_STENCIL_ATTACHMENT,v=q.DEPTH_STENCIL):g.depth?(u=q.DEPTH_STENCIL_ATTACHMENT,v=q.DEPTH24_STENCIL8):(u=q.STENCIL_ATTACHMENT,v=q.STENCIL_INDEX8);f.msaaBuffer?q.renderbufferStorageMultisample(q.RENDERBUFFER,f.multisample,v,h,n):q.renderbufferStorage(q.RENDERBUFFER,v,h,n);q.framebufferRenderbuffer(q.FRAMEBUFFER,u,q.RENDERBUFFER,
t)}}}reset(){this.current=this.unknownFramebuffer;this.viewport=new m.Rectangle}destroy(){this.renderer=null}}e.extension={type:r.ExtensionType.RendererSystem,name:"framebuffer"};r.extensions.add(e);p.FramebufferSystem=e}
goog.provide("module$node_modules$$pixi$core$lib$framebuffer$FramebufferSystem");
goog.global. module$node_modules$$pixi$core$lib$framebuffer$FramebufferSystem=shadow.js.require(147, {});
